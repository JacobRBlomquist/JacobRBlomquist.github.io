<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <script>

navigator.getUserMedia = navigator.getUserMedia || 
					 navigator.webkitGetUserMedia ||
					 navigator.mozGetUserMedia ||
					 navigator.msGetUserMedia;

	let done = false;
	let leftChannel = [];
	let grecorder;
	let recordingLength = 0;
	let PCM32fSamples;
	let sampleRate ;
	let audioContext;

	function successfullyGotInput(stream){
		if(!stream){
			alert("Invalid stream")
			return;		
		}

		const context = window.AudioContext || window.webkitAudioContext;
		audioContext = new context();
		
		sampleRate = audioContext.sampleRate;
		const volume = audioContext.createGain();

		const audioInput = audioContext.createMediaStreamSource(stream);
		audioInput.connect(volume);

		const bufferSize = 2048;
		const recorder = (audioContext.createScriptProcessor || audioContext.createJavaScriptNode).call(audioContext,
													 	bufferSize,
													 	1,
						   							 	1);
		grecorder = recorder;		

		recorder.onaudioprocess = function(event){
			const samples = event.inputBuffer.getChannelData(0);

			leftChannel.push(new Float32Array(samples));
			recordingLength+=bufferSize;
		};

		volume.connect(recorder);
		recorder.connect(audioContext.destination);
		setStatus("Recording...");
	}

	function setStatus(msg){
		document.querySelector("#status").textContent=msg;
	}

	function start(){
		leftChannel = [];
		recordingLength = 0;
		if(grecorder){
			grecorder.connect(audioContext.destination);
			setStatus("Recording...");
			return;
		}
		if(navigator.getUserMedia)
		{
			navigator.getUserMedia({audio:true},
			successfullyGotInput
			, function(error){
				setStatus("Error capturing audio: "+error)
			});
		} else {
			setStatus("getUserMedia is not supported on this browser\nThis only works when using HTTPS, if you get an error, try typing \"https://\" in front of the URL in the address bar.");
			return;
		}

	
        }
	function play(){
		if(!done){
			alert("Recording not complete");
			return;
		}

		console.log(PCM32fSamples);
		
	
		let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
		let channels = 1;
		
		let frameCount = PCM32fSamples.length;
		let audioBuffer = audioCtx.createBuffer(channels,frameCount,sampleRate);
		
		let nowBuffering = audioBuffer.getChannelData(0,32,sampleRate);
		for(let i = 0;i<frameCount;i++)
		{
			nowBuffering[i]  = PCM32fSamples[i];
		}

		let source = audioCtx.createBufferSource();
		source.buffer = audioBuffer;
		source.connect(audioCtx.destination);
		source.start();

        }
	function stop(){
		if(!grecorder)
			return;
		grecorder.disconnect();
		//merge buffers
		PCM32fSamples = new Float32Array(recordingLength);
		let offset = 0;

		for(let i = 0;i<leftChannel.length;i++)
		{
			PCM32fSamples.set(leftChannel[i],offset);
			offset+=leftChannel[i].length;
		}
		done=true;

		let duration = recordingLength / sampleRate;

		let spn = document.querySelector("#status");
		setStatus("Recorded Duration: "+duration.toFixed(3)+"s.");

        }
  </script>
</head>
<body>
  <h1>Record and playback audio in browser.</h1>
  <div>
    <button onclick="start()">Start</button>
    <button onclick="stop()">Stop</button>
    <button onclick="play()">Play</button>
  </div>
  <div>
    <span id=status></span>
  </div>
	
</body>
</html>
